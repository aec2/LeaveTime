<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
    />
    <title>My Leave Time</title>
    <style>
      :root {
        --bg: #0f1221;
        --card: #161a2f;
        --accent: #7aa2ff;
        --muted: #9aa4b2;
        --text: #e9edf3;
        --danger: #ff8a8a;
        --shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
        --radius: 18px;
      }
      html,
      body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        overflow-y: auto;
        overflow-x: hidden;
      }
      body {
        background: radial-gradient(
          1200px 600px at 50% -20%,
          #20264b 0%,
          var(--bg) 60%
        );
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial;
        display: flex;
        align-items: stretch;
        justify-content: stretch;
      }
      .card {
        width: 100%;
        min-height: 100%;
        height: auto;
        background: var(--card);
        border-radius: 0;
        box-shadow: none;
        padding: 28px 28px 20px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }
      .title {
        font-size: clamp(18px, 2.5vw, 22px);
        font-weight: 700;
        letter-spacing: 0.2px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #fff;
        -webkit-app-region: drag;
        cursor: move;
      }
      .title .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--accent);
        box-shadow: 0 0 18px var(--accent);
      }
      .row {
        display: flex;
        gap: 18px;
        margin-top: 18px;
        flex-wrap: wrap;
      }
      .field {
        flex: 1 1 220px;
        background: #0e1224;
        border: 1px solid #252b49;
        border-radius: 12px;
        padding: 14px 16px;
      }
      label {
        display: block;
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 8px;
        letter-spacing: 0.2px;
      }
      input[type="time"] {
        width: 100%;
        font-size: 18px;
        padding: 10px 12px;
        color: #fff;
        background: #111633;
        border: 1px solid #2b3157;
        border-radius: 10px;
        outline: none;
        -webkit-app-region: no-drag;
      }
      input[type="time"]:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(122, 162, 255, 0.2);
      }
      .helper {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }
      .warn {
        color: var(--danger);
      }
      .big {
        margin-top: 22px;
        background: linear-gradient(180deg, #0d1125, #0a0e1e);
        border: 1px solid #23294b;
        border-radius: 16px;
        padding: 26px 22px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .big > div { flex: 1 1 220px; }
      .big .label {
        color: var(--muted);
        font-size: 13px;
        letter-spacing: 0.3px;
      }
      .big .time {
        font-variant-numeric: tabular-nums;
        font-size: clamp(32px, 6vw, 56px);
        font-weight: 800;
        letter-spacing: 1px;
        color: #fff;
      }
      .sub {
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
        color: var(--muted);
        font-size: 13px;
      }
      .pill {
        padding: 6px 10px;
        border-radius: 999px;
        background: #0f1430;
        border: 1px solid #2a2f56;
        color: #c6cce4;
        font-size: 12px;
      }
      .footer {
        margin-top: 16px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      /* Responsive tweaks for smaller windows */
      @media (max-width: 540px) {
        .card { padding: 18px 16px 14px; }
        .row { gap: 12px; }
        .big { padding: 18px 16px; gap: 10px; }
        .sub { flex-direction: column; gap: 8px; }
        .footer { justify-content: center; }
      }

      @media (max-height: 640px) {
        .card { padding: 18px 16px 14px; }
        .title { font-size: clamp(16px, 2.2vw, 20px); }
        .big { padding: 18px 16px; }
        .big .label { font-size: 12px; }
        .pill { padding: 5px 8px; font-size: 11px; }
        .btn { padding: 8px 12px; }
      }
      .btn {
        border: 1px solid #2b3157;
        background: #12173a;
        color: #dfe7ff;
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        -webkit-app-region: no-drag;
      }
      .btn:hover {
        border-color: var(--accent);
      }
      .btn.primary {
        background: var(--accent);
        border-color: var(--accent);
        color: #fff;
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .settings-section {
        margin-top: 18px;
        padding: 18px;
        background: #0d1125;
        border: 1px solid #23294b;
        border-radius: 12px;
      }
      .settings-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      .settings-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text);
      }
      .toggle-btn {
        background: none;
        border: none;
        color: var(--accent);
        cursor: pointer;
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 6px;
        -webkit-app-region: no-drag;
      }
      .toggle-btn:hover {
        background: rgba(122, 162, 255, 0.1);
      }
      .settings-content {
        display: none;
      }
      .settings-content.show {
        display: block;
      }
      .settings-row {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
      .settings-field {
        flex: 1;
        min-width: 200px;
      }
      .settings-field input {
        width: 100%;
        font-size: 13px;
        padding: 8px 10px;
        color: #fff;
        background: #111633;
        border: 1px solid #2b3157;
        border-radius: 8px;
        outline: none;
        -webkit-app-region: no-drag;
      }
      .settings-field input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(122, 162, 255, 0.2);
      }
      .settings-field select {
        width: 100%;
        font-size: 13px;
        padding: 8px 10px;
        color: #fff;
        background: #111633;
        border: 1px solid #2b3157;
        border-radius: 8px;
        outline: none;
        -webkit-app-region: no-drag;
      }
      .settings-field select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(122, 162, 255, 0.2);
      }
      .checkbox-field {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
      }
      .checkbox-field input[type="checkbox"] {
        -webkit-app-region: no-drag;
      }
      .status-message {
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 12px;
        margin-top: 8px;
      }
      .status-success {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #4ade80;
      }
      .status-error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: var(--danger);
      }
      .status-info {
        background: rgba(122, 162, 255, 0.1);
        border: 1px solid rgba(122, 162, 255, 0.3);
        color: var(--accent);
      }
    </style>
  </head>
  <body>
    <main class="card">
      <div class="title"><span class="dot"></span> My Leave Time</div>

      <div id="homePage">
        <div class="row">
          <div class="field">
            <label for="start">Start time (flex: 07:30–09:30)</label>
            <input id="start" type="time" min="07:30" max="09:30" step="300" />
            <div id="rangeHelp" class="helper">
              Pick any time between 07:30 and 09:30.
            </div>
          </div>
          <div class="field" style="display: flex; align-items: flex-end;">
            <button class="btn primary" id="fetchBtn" style="padding: 12px 16px; height: fit-content;">
              Fetch from SSRS
            </button>
          </div>
        </div>

        <section class="big">
          <div>
            <div class="label">Calculated leave time</div>
            <div id="leaveTime" class="time">—:—</div>
          </div>
          <div>
            <div class="label">Selected start</div>
            <div id="startEcho" class="pill">—:—</div>
          </div>
        </section>

        <div class="sub">
          <div class="pill">8h work + 45m break = add 9h 45m</div>
          <div id="exampleEcho" class="helper">Example: 08:00 → 17:45</div>
        </div>

        <div class="footer">
          <button class="btn" id="openSettingsBtn">Settings</button>
          <button class="btn" id="hideBtn">Hide to tray</button>
        </div>
      </div>

      <div id="settingsPage" style="display: none;">
        <div class="settings-header">
          <div class="settings-title">Settings</div>
          <div style="display:flex; gap:10px;">
            <button class="btn" id="backBtn">Back</button>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-header">
            <div class="settings-title">SSRS Report Configuration</div>
          </div>
          <div class="settings-content show" id="settingsContent">
            <div class="settings-row">
              <div class="settings-field">
                <label for="reportUrl">Full Report URL (optional)</label>
                <input
                  type="text"
                  id="reportUrl"
                  placeholder="https://reports.company.com/Reports/report/Folder/ReportName"
                />
              </div>
            </div>
            <div class="settings-row">
              <div class="settings-field">
                <label for="serverUrl">SSRS Server URL</label>
                <input
                  type="text"
                  id="serverUrl" 
                  placeholder="http://your-server/ReportServer"
                />
              </div>
              <div class="settings-field">
                <label for="reportPath">Report Path</label>
                <input 
                  type="text" 
                  id="reportPath" 
                  placeholder="/Reports/AttendanceReport"
                />
              </div>
            </div>
            
            <div class="settings-row">
              <div class="settings-field">
                <label for="username">Username</label>
                <input 
                  type="text" 
                  id="username" 
                  placeholder="domain\\username or username"
                />
              </div>
              <div class="settings-field">
                <label for="password">Password</label>
                <input 
                  type="password" 
                  id="password" 
                  placeholder="••••••••"
                />
              </div>
            </div>
            
            <div class="settings-row">
              <div class="settings-field">
                <label for="employeeId">Employee ID (optional)</label>
                <input 
                  type="text" 
                  id="employeeId" 
                  placeholder="Leave empty for current user"
                />
              </div>
              <div class="settings-field">
                <label for="domain">Domain (optional)</label>
                <input 
                  type="text" 
                  id="domain" 
                  placeholder="COMPANY"
                />
              </div>
            </div>
            
            <div class="checkbox-field">
              <input type="checkbox" id="useWindowsAuth" checked />
              <label for="useWindowsAuth">Use Windows Authentication</label>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 12px;">
              <button class="btn" id="testConnectionBtn">Test Connection</button>
              <button class="btn" id="saveSettingsBtn">Save Settings</button>
            </div>
            
            <div id="statusMessage" class="status-message" style="display: none;"></div>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-header">
            <div class="settings-title">Notifications</div>
          </div>
          <div class="settings-content show" id="notifySettings">
            <div class="settings-row">
              <div class="settings-field">
                <label for="notifyBefore">Notify before leave</label>
                <select id="notifyBefore">
                  <option value="off">Off</option>
                  <option value="5">5 minutes</option>
                  <option value="10">10 minutes</option>
                  <option value="15">15 minutes</option>
                  <option value="20">20 minutes</option>
                  <option value="30">30 minutes</option>
                  <option value="45">45 minutes</option>
                  <option value="60">60 minutes</option>
                </select>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>

    <script>
      // Electron ipcRenderer is available because nodeIntegration=true & contextIsolation=false in index.js
      const { ipcRenderer } = require("electron");

      const FLEX_MIN = toMinutes("07:30");
      const FLEX_MAX = toMinutes("09:30");
      const ADD_MINUTES = 9 * 60 + 45;

      const startInput = document.getElementById("start");
      const leaveTimeEl = document.getElementById("leaveTime");
      const startEchoEl = document.getElementById("startEcho");
      const rangeHelpEl = document.getElementById("rangeHelp");
      const hideBtn = document.getElementById("hideBtn");
      const openSettingsBtn = document.getElementById("openSettingsBtn");
      const backBtn = document.getElementById("backBtn");
      const homePage = document.getElementById("homePage");
      const settingsPage = document.getElementById("settingsPage");
       
      // SSRS elements
      const fetchBtn = document.getElementById("fetchBtn");
      const settingsContent = document.getElementById("settingsContent");
      const reportUrlInput = document.getElementById("reportUrl");
      const serverUrlInput = document.getElementById("serverUrl");
      const reportPathInput = document.getElementById("reportPath");
      const usernameInput = document.getElementById("username");
      const passwordInput = document.getElementById("password");
      const employeeIdInput = document.getElementById("employeeId");
      const domainInput = document.getElementById("domain");
      const useWindowsAuthInput = document.getElementById("useWindowsAuth");
      const testConnectionBtn = document.getElementById("testConnectionBtn");
      const saveSettingsBtn = document.getElementById("saveSettingsBtn");
      const statusMessage = document.getElementById("statusMessage");
      const notifySelect = document.getElementById("notifyBefore");

      function toMinutes(hhmm) {
        const [h, m] = hhmm.split(":").map(Number);
        return h * 60 + m;
      }
      function fromMinutes(total) {
        total = ((total % (24 * 60)) + 24 * 60) % (24 * 60);
        const h = Math.floor(total / 60),
          m = total % 60;
        return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
      }
      function clamp(v, min, max) {
        return Math.min(Math.max(v, min), max);
      }

      function showHome() {
        if (homePage) homePage.style.display = '';
        if (settingsPage) settingsPage.style.display = 'none';
        hideStatus();
        ipcRenderer.send('fit-to-content');
      }

      function showSettings() {
        if (homePage) homePage.style.display = 'none';
        if (settingsPage) settingsPage.style.display = '';
        ipcRenderer.send('fit-to-content');
      }

      function update() {
        const val = startInput.value || "08:00";
        let startMin = toMinutes(val);
        const inRange = startMin >= FLEX_MIN && startMin <= FLEX_MAX;

        if (!inRange) {
          rangeHelpEl.textContent = "Out of range — clamped to 07:30–09:30.";
          rangeHelpEl.classList.add("warn");
        } else {
          rangeHelpEl.textContent = "Pick any time between 07:30 and 09:30.";
          rangeHelpEl.classList.remove("warn");
        }

        startMin = clamp(startMin, FLEX_MIN, FLEX_MAX);
        const leaveMin = startMin + ADD_MINUTES;

        const startTxt = fromMinutes(startMin);
        const leaveTxt = fromMinutes(leaveMin);

        startEchoEl.textContent = startTxt;
        leaveTimeEl.textContent = leaveTxt;

        // Notify main (tray) of the latest values
        ipcRenderer.send("update-leave-time", {
          start: startTxt,
          leave: leaveTxt,
          notifyBeforeMin: getNotifyBeforeMinutes(),
        });
      }

      function getNotifyBeforeMinutes() {
        const val = (notifySelect && notifySelect.value) || 'off';
        if (val === 'off') return 0;
        const n = parseInt(val, 10);
        return Number.isFinite(n) && n > 0 ? n : 0;
      }

      function loadNotifySettings() {
        try {
          const saved = localStorage.getItem('notifyConfig');
          if (saved) {
            const cfg = JSON.parse(saved);
            if (notifySelect && cfg && (cfg.minutesBefore === 0 || cfg.minutesBefore)) {
              notifySelect.value = cfg.minutesBefore > 0 ? String(cfg.minutesBefore) : 'off';
            }
          } else {
            if (notifySelect) notifySelect.value = '15';
          }
        } catch {}
      }

      function saveNotifySettings() {
        const cfg = { minutesBefore: getNotifyBeforeMinutes() };
        localStorage.setItem('notifyConfig', JSON.stringify(cfg));
      }

      function useCurrentTimeClamped() {
        const now = new Date();
        const cur = `${String(now.getHours()).padStart(2, "0")}:${String(
          now.getMinutes()
        ).padStart(2, "0")}`;
        startInput.value = cur;
        update();
      }

      // Init
      startInput.value = "08:00";
      loadNotifySettings();
      loadSSRSSettings(); // Load saved SSRS configuration
      update();
      document.getElementById("exampleEcho").textContent =
        "Examples: 07:30 → 17:15, 08:00 → 17:45, 09:30 → 19:15";

      // SSRS Functions
      function showStatus(message, type = 'info') {
        statusMessage.textContent = message;
        statusMessage.className = `status-message status-${type}`;
        statusMessage.style.display = 'block';
        
        // Auto-hide success messages after 3 seconds
        if (type === 'success') {
          setTimeout(() => {
            statusMessage.style.display = 'none';
          }, 3000);
        }
      }

      function hideStatus() {
        statusMessage.style.display = 'none';
      }

      function getSSRSConfig() {
        return {
          reportUrl: reportUrlInput.value.trim(),
          serverUrl: serverUrlInput.value.trim(),
          reportPath: reportPathInput.value.trim(),
          username: usernameInput.value.trim(),
          password: passwordInput.value,
          employeeId: employeeIdInput.value.trim(),
          domain: domainInput.value.trim(),
          useWindowsAuth: useWindowsAuthInput.checked
        };
      }

      function setSSRSConfig(config) {
        reportUrlInput.value = config.reportUrl || '';
        serverUrlInput.value = config.serverUrl || '';
        reportPathInput.value = config.reportPath || '';
        usernameInput.value = config.username || '';
        passwordInput.value = config.password || '';
        employeeIdInput.value = config.employeeId || '';
        domainInput.value = config.domain || '';
        useWindowsAuthInput.checked = config.useWindowsAuth !== false;
      }

      function loadSSRSSettings() {
        const saved = localStorage.getItem('ssrsConfig');
        if (saved) {
          try {
            const config = JSON.parse(saved);
            setSSRSConfig(config);
          } catch (e) {
            console.error('Failed to load SSRS settings:', e);
          }
        }
      }

      function saveSSRSSettings() {
        const config = getSSRSConfig();
        localStorage.setItem('ssrsConfig', JSON.stringify(config));
        showStatus('Settings saved successfully', 'success');
      }

      async function testSSRSConnection() {
        const config = getSSRSConfig();
        if (!config.reportUrl && !config.serverUrl) {
          showStatus('Please enter SSRS Server URL or full report URL', 'error');
          return;
        }

        testConnectionBtn.disabled = true;
        testConnectionBtn.textContent = 'Testing...';
        showStatus('Testing connection...', 'info');

        try {
          const result = await ipcRenderer.invoke('test-ssrs-connection', config);
          if (result.success) {
            showStatus('Connection successful!', 'success');
          } else {
            showStatus(`Connection failed: ${result.message}`, 'error');
          }
        } catch (error) {
          showStatus(`Test failed: ${error.message}`, 'error');
        } finally {
          testConnectionBtn.disabled = false;
          testConnectionBtn.textContent = 'Test Connection';
        }
      }

      async function fetchEntranceTime() {
        const config = getSSRSConfig();
        if (!config.reportUrl && (!config.serverUrl || !config.reportPath)) {
          showStatus('Please configure SSRS settings first', 'error');
          showSettings();
          ipcRenderer.send('fit-to-content');
          return;
        }

        fetchBtn.disabled = true;
        fetchBtn.textContent = 'Fetching...';
        showStatus('Fetching entrance time from SSRS...', 'info');

        try {
          const result = await ipcRenderer.invoke('fetch-entrance-time', config);
          if (result.success) {
            startInput.value = result.entranceTime;
            update();
            showStatus(`Entrance time fetched: ${result.entranceTime} (from ${result.source})`, 'success');
          } else {
            showStatus(`Failed to fetch: ${result.message}`, 'error');
          }
        } catch (error) {
          showStatus(`Fetch failed: ${error.message}`, 'error');
        } finally {
          fetchBtn.disabled = false;
          fetchBtn.textContent = 'Fetch from SSRS';
        }
      }

      // Events
      startInput.addEventListener("input", update);
      hideBtn.addEventListener("click", () => {
        window.close();
      }); // triggers "close to tray" in main

      // Navigation
      if (openSettingsBtn) openSettingsBtn.addEventListener('click', showSettings);
      if (backBtn) backBtn.addEventListener('click', showHome);

      fetchBtn.addEventListener('click', fetchEntranceTime);
      testConnectionBtn.addEventListener('click', testSSRSConnection);
      saveSettingsBtn.addEventListener('click', saveSSRSSettings);

      // Notification Events
      if (notifySelect) {
        notifySelect.addEventListener('change', () => {
          saveNotifySettings();
          update();
        });
      }

      // Tray menu commands -> renderer
      ipcRenderer.on("tray:use-now", () => useCurrentTimeClamped());
      ipcRenderer.on("tray:set-0800", () => {
        startInput.value = "08:00";
        update();
      });
      ipcRenderer.on("tray:fetch-ssrs", () => fetchEntranceTime());
    </script>
  </body>
</html>